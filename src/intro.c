
#include <string.h>
#include <stdlib.h>
#include <stdio.h>

#include "myheader.h"

extern const unsigned char fire_palette[];
extern const unsigned char title_sprites[];
extern const unsigned char title_sat[];
extern const unsigned char gradient_colrs[];
extern const unsigned char gradient_tiles[];

void FireIteration(char *b) __sdcccall(1);

extern unsigned char demoflag;
extern unsigned char musicflag;

char buffer[32*24];


void InstISRDemo(void) __naked
{
__asm 
	di
	ld	a,#0xC3
	ld  (#0xFD9A+#0),a
	ld	hl,#_myISRDemo
	ld  (#0xFD9A+#1),hl
	ei
	ret
__endasm;
}

void DistISRDemo(void) __naked
{
__asm 
	ld	a,#0xC9
	ld  (#0xFD9A+#0),a
	ret
__endasm;
}

void myISRDemo(void)  __naked
{						
__asm 
	ld	e, #b_audioplay
	ld	hl, #_audioplay
	call	___sdcc_bcall_ehl
	ret
__endasm;
}

void intro(void) __banked  
{
	const unsigned char ClrSign = 10;
	
	chgmod(4);						  		// Init Screen 4
	myVDPwrite(0,7);						// borders	
	RG1SAV |= 2;
	myVDPwrite(RG1SAV,1);
	RG8SAV |= 32;
	myVDPwrite(RG8SAV,8);
	
	SetPalette(fire_palette);
	
	SetVramW14(0x1800);
	for (int i=32*24;i>0;i--) {
		Port98 = 0;
	}

	SetVramW14(0x3800);
	VramWrite((unsigned int)title_sprites,32*32);

	SetVramW14(0x1C00);
	for (int i=32*16;i>0;i--) {
		Port98 = ClrSign;
	}

	SetVramW14(0x1E00);
	VramWrite((unsigned int)title_sat,32*4);
		
	SetVramW14(0);
	for (char j=0;j<16*3;j++) {
		VramWrite((unsigned int)gradient_tiles,8*16);
	}

	SetVramW14(0x2000);
	for (char s=0;s<3;s++) {
		for (int i=64*8;i>0;i--) {
			Port98 = 0;
		}
		for (char i=0;i<64;i++) {
			char k = i/4;
			for (char j=0;j<8;j++) {
				Port98 = gradient_colrs[k];
			}
		}
		for (int i=128*8;i>0;i--) {
			Port98 = 0;
		}
	}

	memset(&buffer[0],0,24*32);
	memset(&buffer[23*32],127,32);

	audiosfxinit(6);						// music 6
	InstISRDemo();							// start music	

	
	while (myCheckkbd(7)==0xFF)	
	{
		FireIteration(buffer);
		SetVramW14(0x1800);
		VramWrite((unsigned int)&buffer[0],3*256);		
	}

	memset(&buffer[23*32],0,32);	

	for (unsigned char s = 20;s>0;s--)  
	{
		unsigned char k = ((unsigned)ClrSign*s)/20;
		FireIteration(buffer);
		SetVramW14(0x1800);
		VramWrite((unsigned int)&buffer[0],3*256);		

		SetVramW14(0x1C00);
		for (unsigned int i=32*16;i>0;i--) {
			Port98 = k;
		}

	}
	
	DistISRDemo();							// stop music	
	audioinit();	
}

void FireIteration(char *b) __sdcccall(1)
{
	b;
	__asm
	.zxn 
	
	ld	bc, #0x02e0
	add	hl, bc
	ld	iyh, #0x17
00110$:
	ex	de, hl
	ld	b,#0x20
00107$:
	exx
	call	_MyRand
	exx
	and	a, #0x0f
	ld	c, a
	and	a, #0x03
	ld hl,#0xffde
	add	a, l
	ld	l, a
	ld	a, #0
	adc	a, h
	ld	h, a
	add hl,de
	ld	a, (de)
	sub	a,c
	jr	c, 00102$
	ld	(hl), a
	jp	00103$
00102$:
	ld	(hl),#0
00103$:
	inc	de
	djnz 00107$
	ld	hl, #0xffc0
	add	hl, de
	dec	iyh
	jp	nz,00110$
	ret
	
	__endasm;
	
/*	
	char *v = &b[23*32];
	for (char j=23;j>0;j--) 
	{
		for (char i=32;i>0;i--)
		{
			char w = (MyRand()&15);
			if (*v>w) 
				*(v-32-2+(w&3)) = *v-w;
			else
				*(v-32-2+(w&3)) = 0;
			v++;
		}
		v += -64;
	}
*/
}


int g_RandomSeed8 = 5;

char MyRand(void) __naked  __preserves_regs(b,c,iyl,iyh)
{
__asm
	ld	hl, (_g_RandomSeed8)
	ld      a, r
	ld      d, a
	ld      e, a
	add     hl, de
	xor     l
	add     a,a
	xor     h
	ld      l, a
	ld	(_g_RandomSeed8), hl
	ret
__endasm;
}



void SetPalette(char *palette) __sdcccall(1)
{
	palette;
__asm
	ld	bc,#0x1000		; 16 colours
SPcoLoop:
	ld	a,c
	di
	out	(#0x99),a	; colour Nr.
	ld	a, #128+#16
	out	(#0x99),a       
	ld	a,(hl)		; red
	sla	a
	sla	a
	sla	a
	sla	a			; bits 4-7
	inc	hl
	inc	hl
	or	a,(hl)		; blue bits 0-3
	out	(#0x9A),a
	dec	hl
	ld	a,(hl)		; green bits 0-3
	inc	hl
	inc	hl
	ei 
	out	(#0x9A),a
	inc c
	djnz	SPcoLoop
	ret
__endasm;
}

// -----------------------------------------------
// 	Sets palette, provide table pointer
// 
void RestorePalette(void) __naked
{
__asm
	ld	hl, #__msx_palette
	jp	_SetPalette
	
;---------------------------------------------------
;        colour  R  G  B   bright 0..7   Name
;---------------------------------------------------
__msx_palette:
	.db #0,#0,#0		;transparent
	.db #0,#0,#0		;black
	.db #1,#6,#1		;bright green
	.db #3,#7,#3		;light green
	.db #1,#1,#7		;deep blue
	.db #2,#3,#7		;bright blue
	.db #5,#1,#1		;deep red
	.db #2,#6,#7		;light blue
	.db #7,#1,#1		;bright red
	.db #7,#3,#3		;light red
	.db #6,#6,#1		;bright yellow
	.db #6,#6,#3		;pale yellow
	.db #1,#4,#1		;deep green
	.db #6,#2,#5		;purple
	.db #5,#5,#5		;grey
	.db #7,#7,#7		;white
__endasm;
}	
	
	

const char fire_palette[] = {
     0x0,0x0,0x0,
     0x1,0x0,0x0,
     0x2,0x0,0x0,
     0x3,0x0,0x0,
     0x4,0x1,0x0,
     0x5,0x2,0x0,
     0x6,0x2,0x0,
     0x6,0x3,0x0,
     0x6,0x3,0x0,
     0x6,0x4,0x0,
     0x6,0x4,0x0,
     0x5,0x4,0x0,
     0x5,0x5,0x1,
     0x5,0x5,0x1,
     0x6,0x6,0x4,
     0x7,0x7,0x7
};

// ****************************************
// * Sprite Patterns                       
// ****************************************
const char title_sprites[] = {
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x03,0x00,0x00,0x07,0x3F,0x07,0x01,0x01,
 0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x3F,
 0xFF,0xFF,0x7F,0xFF,0xFF,0xFC,0xF8,0xF0,
 0x00,0x00,0x00,0x00,0x00,0x3F,0xFF,0xFF,
 0xFF,0xFF,0xF8,0xC0,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0xF0,0xF8,0xFC,
 0xFE,0xFE,0x7F,0x1F,0x1F,0x1F,0x3F,0x7F,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,
 0x03,0x03,0x07,0x0F,0x0F,0x0F,0x3F,0xFF,
 0x0F,0x7F,0x3F,0x7F,0x7F,0xFE,0xFC,0xF8,
 0xF0,0xF0,0xF0,0xF0,0xE0,0xC0,0xC0,0xC0,
 0xE0,0xC0,0x80,0x00,0x00,0x03,0x00,0x01,
 0x30,0x78,0x78,0xFF,0xFF,0xFF,0xFF,0xFF,
 0x1F,0xFF,0x3F,0x1F,0x3F,0xFF,0xFF,0xF0,
 0x00,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF,
 0xFF,0xFE,0xFE,0xFC,0xFC,0xF0,0x80,0x01,
 0x00,0x07,0x09,0x00,0xFE,0xF1,0x01,0xD3,
 0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF0,
 0xF8,0xF8,0xFB,0xE7,0xDF,0xBF,0xF8,0xF0,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0xF8,0xFC,0xFE,0xFE,0xFE,0xFC,0x3C,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x01,0x3F,0x1F,0x3F,0x78,0x70,0xE0,0xC0,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0xE0,0xF8,0xF8,0xF8,0xFC,0x7C,0x3E,0x3E,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x01,0x07,0x1F,0x7F,0x3E,0x3C,0x78,0x78,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0xE0,0xF8,0xF0,0xF8,0x3E,0x3F,0x1F,0x1F,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x1F,0x7F,0x3F,0x3F,0x0F,0x07,0x07,0x07,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0xC0,0xC0,0xE0,0xE0,0xEE,0xDF,0x87,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,
 0xFF,0x3F,0x1F,0x0F,0x0F,0x1F,0x1F,0x1F,
 0x0F,0x07,0x01,0xFF,0x1F,0x00,0x00,0x00,
 0xC0,0xC0,0xC0,0xE0,0xE0,0xF0,0xF8,0xFE,
 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,
 0x6C,0x00,0x00,0x00,0x00,0x01,0x07,0x3F,
 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,
 0x0F,0x1C,0x1C,0x78,0xF8,0xF0,0xF0,0xE0,
 0xC0,0x80,0x80,0x00,0xFF,0xFF,0x00,0x00,
 0x03,0x07,0x07,0x0F,0x0F,0x0F,0x1F,0x1F,
 0x1F,0x0F,0x0F,0x07,0xFF,0xFF,0x00,0x00,
 0xE0,0xE0,0xE0,0xFC,0xF0,0xE0,0xE0,0xE0,
 0xE0,0xC0,0xC0,0x80,0xFC,0xFF,0x00,0x00,
 0x19,0x09,0x03,0x03,0x03,0x03,0x03,0x07,
 0x3F,0x07,0x01,0x00,0x00,0xFF,0x00,0x00,
 0xC0,0xC3,0x9F,0xF9,0x80,0xC0,0xC0,0xE0,
 0xF0,0xFF,0xFF,0xFF,0x7F,0xFC,0x00,0x00,
 0x7E,0xF8,0xF0,0xE1,0x01,0x0C,0x19,0x31,
 0xE1,0xC0,0xC0,0xC0,0x80,0xFF,0x00,0x00,
 0x70,0xF0,0xE1,0x9F,0xF0,0xC0,0xE0,0xF0,
 0xF8,0xFF,0xFF,0x7F,0x3F,0xFF,0x00,0x00,
 0x3E,0x7E,0xFC,0xF0,0xC3,0x0C,0x18,0x30,
 0x71,0xE1,0xE1,0xC0,0x80,0xFF,0x00,0x00,
 0x07,0x0F,0x0F,0x1F,0xFF,0xFF,0x7E,0xFE,
 0xFE,0xFC,0xFC,0xF8,0x60,0xFF,0xFF,0x00,
 0x83,0x83,0x03,0x03,0x03,0x07,0x07,0x0F,
 0x0F,0x1F,0x1F,0x0F,0x07,0xFF,0xFF,0x01,
 0xE0,0xF0,0xF0,0xF0,0xF0,0xF0,0xE0,0xE0,
 0xE0,0xC0,0xC0,0x80,0x00,0xFF,0xFF,0xFF,
 0x00,0x03,0x3F,0x0F,0xFF,0x1F,0x07,0x1F,
 0x03,0x07,0x3F,0x1F,0x07,0x03,0x07,0x07,
 0x70,0xFC,0xFE,0xFF,0xFF,0xFF,0xFF,0xF1,
 0xF8,0xFC,0xFC,0xFC,0xF8,0xF0,0xE0,0xE0,
 0x00,0x00,0x00,0x80,0xE0,0xF0,0xF8,0xFC,
 0x7E,0x3E,0x3F,0x1F,0x1F,0x1F,0x1F,0x1F,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x0F,0x0F,0x0F,0x1F,0x7F,0xFF,0xFF,0x7F,
 0x3F,0x7E,0x7E,0x7E,0xFC,0xFC,0xFC,0xF8,
 0xC0,0xC0,0xC0,0x81,0xFF,0xFF,0xFF,0x03,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x3E,0x3E,0x7C,0xF8,0xE0,0xC0,0xF0,0xF8,
 0xFC,0x7E,0x3E,0x3F,0x1F,0x1F,0x1F,0x1F,
 0x00,0x00,0x00,0x00,0x1F,0x07,0x03,0x07,
 0x07,0x0E,0x0C,0x1C,0x1C,0x39,0x3F,0x38,
 0x00,0x00,0x00,0xFE,0xFF,0xFF,0xFF,0x8F,
 0x07,0x03,0x03,0x07,0x3F,0xFF,0x9E,0x00,
 0x07,0x03,0x01,0x3F,0x87,0x9F,0x8F,0xC7,
 0xC7,0xE3,0xE3,0xE3,0x83,0x07,0x07,0x07,
 0x00,0xC0,0xE0,0xE0,0xE1,0xE7,0x9F,0x7F,
 0xFF,0xF1,0x80,0xC0,0xC0,0xC0,0xE0,0xE0,
 0x00,0x00,0x00,0x00,0xE0,0xF0,0xF1,0xFB,
 0xFB,0xFB,0xF7,0x67,0x0F,0x0F,0x0E,0x3F,
 0x00,0x00,0x00,0x0F,0x5F,0xFF,0xFF,0xE7,
 0xC3,0xC1,0x83,0x07,0x1F,0x7F,0xFE,0x98,
 0x00,0x00,0x00,0x8F,0x81,0xC0,0xF0,0xE1,
 0xFF,0xF3,0xF0,0xE0,0xC0,0x90,0x20,0x60,
 0x18,0xFE,0x3F,0xFF,0xFF,0x3E,0x1C,0xFF,
 0xFF,0xFF,0x3C,0x7E,0x7E,0x78,0xF8,0xF4,
 0x00,0x00,0x00,0x00,0x00,0x00,0x78,0xFC,
 0xFC,0xF8,0xF0,0x00,0x00,0x04,0x08,0x10,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
 0x01,0x01,0x03,0x03,0x07,0x0F,0x1F,0x3F,
 0xFF,0xFF,0xFF,0x7F,0x3F,0x3F,0x1F,0x0F,
 0xF8,0xF8,0xF8,0xF0,0xF0,0xF7,0xFF,0xFF,
 0xFF,0xFF,0xFF,0xE0,0xC0,0x80,0x80,0x00,
 0x00,0x00,0x00,0x01,0x1F,0xFF,0xFF,0xFF,
 0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
 0x1F,0x3F,0x7E,0xFE,0xFC,0xFC,0xF8,0xE0,
 0x80,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
 0x3C,0x3C,0x3E,0x7F,0x3F,0x3F,0x0F,0x07,
 0x00,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,
 0x00,0x01,0x03,0x0E,0xFC,0xFC,0xFC,0xF8,
 0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,
 0xCF,0x8F,0x1F,0x3F,0x3F,0x7F,0x3F,0x1F,
 0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,
 0xC0,0xC0,0xC0,0xC0,0xC0,0x80,0x80,0x00,
 0x00,0xFF,0xFF,0xFF,0x01,0x00,0x00,0x00,
 0xF4,0x1E,0x0E,0x0F,0x07,0x0F,0x07,0x03,
 0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,
 0x00,0x01,0x07,0x1F,0xFF,0xFF,0xFE,0xF0,
 0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,
 0xE0,0xF1,0xF1,0xE1,0xC1,0x01,0x00,0x00,
 0x00,0xFF,0xFF,0xFF,0xFF,0x01,0x00,0x00,
 0xE4,0xE2,0xFB,0xFF,0xFF,0xFF,0xFF,0xFF,
 0x7F,0xF8,0x1F,0xFF,0xFF,0xFF,0x00,0x00,
 0x38,0xF0,0xF0,0xE8,0xFC,0xF8,0xF0,0xEE,
 0xE0,0xFF,0x80,0xFC,0xE0,0xFF,0x18,0x0E     
};

const unsigned char title_sat[] = 
{
         7,48+  0,  0,3  , 
        23,48+ 16, 16,3  , 
        39,48+ 32, 48,3  , 
        87,48+ 80, 88,3  , 
       103,48+ 96,120,3  , 
         7,48+ 16,  4,3  , 
        23,48+  0, 12,3  , 
        39,48+ 48, 52,3  , 
        87,48+ 64, 84,3  , 
       103,48+112,124,3  , 
         7,48+ 32,  8,3  , 
        23,48+ 48, 24,3  , 
        39,48+  0, 40,3  , 
        87,48+112, 96,3  , 
       103,48+ 64,112,3  , 
        23,48+ 32, 20,3  , 
        39,48+ 16, 44,3  , 
        87,48+ 96, 92,3  , 
       103,48+ 80,116,3  , 
        23,48+ 80, 32,3  , 
        39,48+ 96, 64,3  , 
       103,48+ 32,104,3  , 
        23,48+ 64, 28,3  , 
       103,48+ 48,108,3  , 
        39,48+ 64, 56,3  , 
        71,48+ 32, 68,3  , 
        87,48+ 48, 80,3  , 
        23,48+ 96, 36,3  , 
        39,48+ 80, 60,3  , 
        71,48+ 48, 72,3  , 
        87,48+ 32, 76,3  , 
       103,48+ 16,100,3               
};
// ****************************************

const char gradient_colrs[] = {
	0x10,0x21,0x32,0x43,0x54,0x65,0x76,0x87,
	0x98,0xA9,0xBA,0xCB,0xDC,0xED,0xFE,0xFF
	};

const char gradient_tiles[] = {
	0x00,0x00,0x00,0x88,0x00,0x00,0x00,0x88,
	0x00,0x22,0x00,0x88,0x00,0x22,0x00,0x88,    
	0x00,0x22,0x00,0xAA,0x00,0x22,0x00,0xAA,    
	0x00,0xAA,0x00,0xAA,0x00,0xAA,0x00,0xAA,    
	0x00,0xAA,0x44,0xAA,0x00,0xAA,0x44,0xAA,    
	0x11,0xAA,0x44,0xAA,0x11,0xAA,0x45,0xAA,    
	0x11,0xAA,0x55,0xAA,0x11,0xAA,0x55,0xAA,    
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,0xAA,    
	0x55,0xAA,0x55,0xEE,0x55,0xAA,0x55,0xEE,    
	0x55,0xBB,0x55,0xEE,0x55,0xBB,0x55,0xEE,    
	0x55,0xBB,0x55,0xFF,0x55,0xBB,0x55,0xFF,    
	0x55,0xFF,0x55,0xFF,0x55,0xFF,0x55,0xFF,    
	0x55,0xFF,0xDD,0xFF,0x55,0xFF,0xDD,0xFF,    
	0x77,0xFF,0xDD,0xFF,0x77,0xFF,0xDD,0xFF,    
	0x77,0xFF,0xFF,0xFF,0x77,0xFF,0xFF,0xFF,    
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF    
};

	